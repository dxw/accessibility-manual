{% assign sections = site.pages | site_sections %}
{% assign parent_page = site.pages | parent_of: page %}

<aside class="related">
  <nav aria-label="Site navigation">
    <ul>
      {% for section in sections %}
          <li class="related__section-link">
            <a class="{% if section.url == page.url %}current{% endif %}" href="{{ section.url | relative_url }}">{{ section.title }}</a>
              {% assign grouped_related_pages = site.pages | children_of: section | group_by: "related_order" | sort: "name" %}
              {% if grouped_related_pages.size > 0 %}
                <label class="visually-hidden" for="section-{{ forloop.index }}">Toggle page links in this section</label>
                <input class="related__expand-toggle arrow" type="checkbox" name="section-{{ forloop.index }}" id="section-{{ forloop.index }}"
                aria-controls="related-section-list-{{ forloop.index }}" {% if section.url == page.url or section.url == parent_page.url %}checked{% endif %}>
                <ul class="related__section-list" id="related-section-list-{{ forloop.index }}">
                  {% for related_page_group in grouped_related_pages %}
                    {% assign related_pages = related_page_group.items | sort_natural: "title" %}
                    {% for related_page in related_pages %}
                      {% unless related_page.unrelatable %}
                        <li>
                          <a class="{% if related_page.url == page.url %}current{% endif %}" href="{{ related_page.url }}">
                            {{ related_page.title }}
                          </a>
                        </li>
                      {% endunless %}
                    {% endfor %}
                  {% endfor %}
                </ul>
              {% endif %}
          </li>
      {% endfor %}
    </ul>
  </nav>
</aside>
